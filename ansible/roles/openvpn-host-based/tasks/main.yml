---
- name: Ensure OpenVPN is installed
  apt:
    name: openvpn
    state: present
    update_cache: yes

- name: Download EasyRSA
  get_url:
    url: "https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz"
    dest: /tmp/EasyRSA-3.0.8.tgz

- name: Extract EasyRSA
  unarchive:
    src: /tmp/EasyRSA-3.0.8.tgz
    dest: /etc/openvpn
    remote_src: yes

- name: Move EasyRSA directory
  command: mv /etc/openvpn/EasyRSA-3.0.8 /etc/openvpn/easy-rsa

- name: Initialize the PKI directory
  command: /etc/openvpn/easy-rsa/easyrsa init-pki
  args:
    creates: /etc/openvpn/pki

- name: Build CA
  command: /etc/openvpn/easy-rsa/easyrsa build-ca nopass
  args:
    creates: /etc/openvpn/pki/ca.crt

- name: Generate server certificate and key
  command: /etc/openvpn/easy-rsa/easyrsa build-server-full server nopass
  args:
    creates: /etc/openvpn/pki/issued/server.crt

- name: Generate Diffie-Hellman parameters
  command: /etc/openvpn/easy-rsa/easyrsa gen-dh
  args:
    creates: /etc/openvpn/pki/dh.pem

- name: Copy server certificates and keys
  copy:
    src: /etc/openvpn/pki/issued/server.crt
    dest: /etc/openvpn/server.crt
  notify: Restart OpenVPN

- name: Copy server key
  copy:
    src: /etc/openvpn/pki/private/server.key
    dest: /etc/openvpn/server.key
  notify: Restart OpenVPN

- name: Copy CA certificate
  copy:
    src: /etc/openvpn/pki/ca.crt
    dest: /etc/openvpn/ca.crt
  notify: Restart OpenVPN

- name: Copy DH parameters
  copy:
    src: /etc/openvpn/pki/dh.pem
    dest: /etc/openvpn/dh.pem
  notify: Restart OpenVPN

- name: Configure OpenVPN
  template:
    src: server.conf.j2
    dest: /etc/openvpn/server.conf
  notify: Restart OpenVPN

- name: Enable and start OpenVPN service
  systemd:
    name: openvpn@server
    state: started
    enabled: yes

handlers:
  - name: Restart OpenVPN
    service:
      name: openvpn@server
      state: restarted
